<h2>Manage Salaries</h2>

<table>
  <tr>
    <th>Emp ID</th>
    <th>Name</th>
    <th>Actions</th>
  </tr>

  <% @employees.each do |employee| %>
    <tr>
      <td><%= employee.id %></td>
      <td>
        <button onclick="toggleSalarySection(<%= employee.id %>)"><%= employee.name %></button>
      </td>
      <td></td>
    </tr>

    <tr id="salary_<%= employee.id %>" style="display: none;">
      <td colspan="3">
        <div>
          <h3>Salary History</h3>
          <ul id="salary-history-<%= employee.id %>"></ul>

          <h3>Add Salary</h3>
          <form onsubmit="addSalary(event, <%= employee.id %>)">
            <label>Month:</label>
            <select id="month_<%= employee.id %>">
              <% Date::MONTHNAMES.compact.each_with_index do |m, i| %>
                <option value="<%= i+1 %>"><%= m %></option>
              <% end %>
            </select>

            <label>Year:</label>
            <select id="year_<%= employee.id %>">
              <% (Date.today.year - 2..Date.today.year).to_a.each do |y| %>
                <option value="<%= y %>"><%= y %></option>
              <% end %>
            </select>

            <label>Amount:</label>
            <input type="number" id="amount_<%= employee.id %>" required />

            <button type="submit">Add</button>
          </form>
        </div>
      </td>
    </tr>
  <% end %>
</table>

<script>
  function toggleSalarySection(empId) {
    var row = document.getElementById('salary_' + empId);
    row.style.display = row.style.display === "none" ? "table-row" : "none";

    fetch(`/admin/salaries/history?employee_id=${empId}`)
      .then(response => response.json())
      .then(data => {
        let historyList = document.getElementById('salary-history-' + empId);
        historyList.innerHTML = data.map(salary => `<li>${salary.month}/${salary.year}: â‚¹${salary.amount}</li>`).join("");
      });
  }

  function addSalary(event, empId) {
    event.preventDefault();
    fetch('/admin/salaries', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        employee_id: empId,
        month: document.getElementById('month_' + empId).value,
        year: document.getElementById('year_' + empId).value,
        amount: document.getElementById('amount_' + empId).value
      })
    }).then(() => toggleSalarySection(empId));
  }
</script>
